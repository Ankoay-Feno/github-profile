name: Update Dog Image

on:
  schedule:
    - cron: '30 * * * *'
  workflow_dispatch:

jobs:
  update-dog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with PAT
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Git Identity
        run: |
          git config --global user.name "Ankoay-Feno"
          git config --global user.email "ankoayfeno@gmail.com"

      - name: Get Random Dog Image and Advice
        id: dog
        run: |
          DOG_RESPONSE=$(curl -s https://dog.ceo/api/breeds/image/random)
          IMG_URL=$(echo "$DOG_RESPONSE" | jq -r '.message')
          ADVICE=$(curl -s https://api.adviceslip.com/advice | jq -r '.slip.advice')
          
          cat <<EOF > README.md
          ## üê∂ Derni√®re image al√©atoire
          ![Photo de chien al√©atoire]($IMG_URL)
          **Conseil du jour:** "$ADVICE"
          *Mis √† jour: $(date -u +'%Y-%m-%d %H:%M UTC')*
          EOF

      - name: Create and Switch Branch
        run: |
          git checkout -b "dog-update-$(date +'%Y%m%d-%H%M%S')"

      - name: Commit Changes
        run: |
          git add README.md
          git commit -m "ü¶¥ Nouvelle image de chien al√©atoire"

      - name: Push Changes
        run: |
          git push https://${{ secrets.PAT_TOKEN }}@github.com/${{ github.repository }}.git "dog-update-$(date +'%Y%m%d-%H%M%S')"
          
      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          title: "üê∂ Nouvelle image de chien al√©atoire"
          body: "Image g√©n√©r√©e automatiquement depuis dog.ceo/api"
          labels: automated,dog
          base: main
          branch: "dog-update-$(date +'%Y%m%d-%H%M%S')"
          delete-branch: true

      - name: Auto-Merge PR
        if: steps.pr.outputs.pull-request-number
        run: |
          gh pr merge ${{ steps.pr.outputs.pull-request-number }} --merge --auto
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}